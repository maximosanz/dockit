{% extends 'all/base.html' %}{% block title %}{{ target.name }} Models{% endblock %}
{% block content %}
{% django_js jquery=false %}
{% load static from staticfiles %}
<h1>{{ target.name }} models</h1>

<table class="toptable">
<tr><td><form method="get" action="{% static "csv/"|add:target.name|add:"_models.csv" %}"><button type="submit">Download data for {{ target.name }} models</button></form></td><td>Download the complete table with all models for {{ target.name }} as a CSV file</td></tr>
<tr><td><form method="get" action="{% static "csv/all_models.tar.gz" %}"><button type="submit">Download data for all models</button></form></td><td>Download the complete table with all models as a CSV file</td></tr>
</table><br>

<p><a href="{% url 'target_info' target.name %}">View target details</a></p><br>

<button id="popover" type="button" class="btn btn-default">
  Select Columns
</button><br><br>

<table id="target_models_table" class="tablesorter bootstrap-popup">
<thead>
<tr>
<th data-priority="critical" class="filter-false sorter-false th.selectmodel select_model">Select</th>
<th data-priority="1" class="th.number" data-placeholder="e.g. <=5">Method rank</th>
<th data-priority="1" class="filter-select th.method.name method">Method</th>
<th data-priority="2" class="filter-select th.refinement.name refinement">Refinement</th>
<th data-priority="3" class="th.i_rmsd i_rmsd_model" data-placeholder="e.g. '<=8'">I-RMSD</th>
<th data-priority="4" class="columnSelector-false th.l_rmsd l_rmsd" data-placeholder="e.g. '<15'">L-RMSD</th>
<th data-priority="5" class="columnSelector-false th.r_rmsd r_rmsd" data-placeholder="e.g. '<4'">R-RMSD</th>
<th data-priority="3" class="th.fnat fnat" data-placeholder="e.g. '>0.5'">Fnat</th>
<th data-priority="3" class="sorter-capri_rank filter-select th.capri_rank">CAPRI Rank</th>
<th data-priority="5" class="columnSelector-false th.dasa" data-placeholder="e.g. '<5000'">&#916;ASA</th>
<th data-priority="5" class="columnSelector-false th.no_clashes" data-placeholder="e.g. '<60'">No. of clashes</th>
<th data-priority="5" class="columnSelector-false th.i_l_rmsd l_i_rmsd" data-placeholder="e.g. '<3.1'">I-L-RMSD</th>
</tr>
</thead>
<tbody>
{% for model in results %}
<tr class="bodytr" name="{{ model.id }}" onMouseOver="create_tooltip('{{ model.id }}','{{ model.target__name }}','{{ model.target__difficulty }}','{{ model.method__name }}','{{ model.refinement__name }}','{{ model.i_rmsd }}','{{ model.l_rmsd }}','{{ model.r_rmsd }}','{{ model.fnat }}','{{ model.i_l_rmsd }}');">
<td class="td.modelcheckbox" style="width:40px"><center><input name="results/{{ model.method__name_lower }}/{{ model.refinement__name_lower }}/{{ model.target__difficulty_lower }}/{{ model.target__name }}/{{ model.target__name }}_{{ model.method__name_lower }}_{{ model.refinement__name_lower }}_{{ model.number }}.pdb-{{ model.target__receptor_bound_chain }}-fitted" class="modelcheckbox select_model" type="checkbox"></center></td>
<td class="td.number">{{ model.number }}</td>
<td class="td.method.name row_id_{{ model.id }}" style='width:160px'>{{ model.method__name }}</td>
<td class="td.refinement.name row_id_{{ model.id }}" style='width:135px'>{{ model.refinement__name }}</td>
<td class="td.i_rmsd row_id_{{ model.id }}">{{ model.i_rmsd }}</td>
<td class="td.l_rmsd row_id_{{ model.id }}">{{ model.l_rmsd }}</td>
<td class="td.r_rmsd row_id_{{ model.id }}">{{ model.r_rmsd }}</td>
<td class="td.fnat row_id_{{ model.id }}" style='width:100px'>{{ model.fnat }}</td>
<td class="td.capri_rank">{{ model.capri_rank }}</td>
<td class="td.dasa">{{ model.dasa }}</td>
<td class="td.no_clashes">{{ model.no_clashes }}</td>
<td class="td.i_l_rmsd row_id_{{ model.id }}">{{ model.i_l_rmsd }}</td>
<td class="td.viewmodel" style='width:95px'><a href="{% url 'model' model.id %}" class="view_model">View model</a></td>
</tr>
{% endfor %}
</tbody>
</table>
<div id="ts-pager" class="ts-pager">
  <form>
    <img src="{% static "tablesorter/addons/pager/icons/first.png" %}" class="first"/>
    <img src="{% static "tablesorter/addons/pager/icons/prev.png" %}" class="prev"/>
    <span class="pagedisplay"></span>
    <img src="{% static "tablesorter/addons/pager/icons/next.png" %}" class="next"/>
    <img src="{% static "tablesorter/addons/pager/icons/last.png" %}" class="last"/>
    <select class="pagesize">
      <option selected="selected" value="10">10</option>
      <option value="20">20</option>
      <option value="30">30</option>
      <option value="40">40</option>
    </select>
  </form>
</div>
<br>

<table class="table" style="width:600px;">
<tr><td>Change JSmol view</td></tr>
<tr><td><input type="submit" id="deselectmodels" value="Deselect all models">&nbsp;&nbsp;
<input type="submit" value="Update view" onclick="re_render();"></td></tr>
</table>

<script>
$('#target_models_table .modelcheckbox').click(function(){
if (this.checked) {
	this.setAttribute('checked','checked');
}
if (!this.checked) {
	this.removeAttribute('checked');
}});
</script>
<script>
//colour array
var colour_array = ["lightgreen","gold","sienna","turquoise","darkgreen","orange","purple","slategray","mistyrose","beige"];
</script>

<script>
$('#deselectmodels').click(function(){
    $('#target_models_table .modelcheckbox').prop('checked', false);
    $('#target_models_table .modelcheckbox').removeAttr('checked');
});
</script>

<style id="css">
#popover-target label {
  margin: 0 5px;
  display: block;
}
#popover-target input {
  margin-right: 5px;
}
.popover {
  margin-top: -65px; /* adjust popover position */
}
</style>
<script id="js">$(function() {

$('#popover')
    .popover({
      placement: 'right',
      html: true, // required if content has HTML
      content: '<div id="popover-target"></div>'
    })
    // bootstrap popover event triggered when the popover opens
    .on('shown.bs.popover', function () {
      // call this function to copy the column selection code into the popover
      $.tablesorter.columnSelector.attachTo( $('.bootstrap-popup'), '#popover-target');
    });


});
</script>

<table name="layout_table"><tr><td class="jsmol">
<script>
//jsmol scripts will go here
//create JSMol window
jmolApplet0 = Jmol.getApplet("jmolApplet0", info);
Jmol.script(jmolApplet0,"background white;");

function re_render() {
//find which models are selected and create an array of filepaths
var models_selected = [];
counter = 0;
$('#target_models_table .modelcheckbox').each(function() {
$(this).parent().css( "background-color", "white" );
});
$('#target_models_table [checked="checked"]').each(function() {
boxid=this.getAttribute('name');
models_selected.push(Django.static(boxid));
//change background colour of checked cells
$(this).parent().css( "background-color", colour_array[counter] );
counter = counter + 1;
});

//get static urls for native receptor and ligand
var receptor = Django.static('benchmarks/{{ target.name }}_r_b.pdb');
var native_ligand = Django.static('benchmarks/{{ target.name }}_l_b.pdb');

//only allow 10 models to be selected
if (models_selected.length > 10) {
	alert("Too many models selected: maximum 10");
} else {
	//construct load and colour command
	var load_files = "load FILES \""+receptor+"\" \""+native_ligand+"\"";
	for (var i=0; i<models_selected.length; i++) {
		load_files += " \""+models_selected[i]+"\"";
	}
	load_files += "; CARTOON only; frame ALL; {{ hide_rec_chains }}; display displayed or (model=1.1); color (model=1.1) red; color (model=2.1) blue;";

	for (var i=0; i<models_selected.length; i++) {
		load_files += " color (model="+(i+3)+".1) translucent 0.4 "+colour_array[i]+";";
	}
	Jmol.script(jmolApplet0,load_files);
}
}
</script>
</td><td>
<table class="table">
<tr><td style="background-color:red; width:60px"><center><font color="white"><b>Red</b></font></center></td>
<td>Native receptor</td></tr>
<tr><td style="background-color:blue; width:60px"><center><font color="white"><b>Blue</b></font></center></td>
<td>Native ligand</td></tr>
<tr><td colspan="2">The model ligands are coloured as shown in the table above</td></tr></table>

</td></tr></table>

<form name="term_form" onSubmit="return false">
JSMol terminal:&nbsp;&nbsp;<input type="text" name="terminal" style="width: 300px" />
<button onClick=update_Jmol(document.term_form.terminal.value)>Update</button>
<button onClick=reset_Jmol();>Reset</button></form><br>

<script>
$(document).ready(re_render());

//if model id is not in list of tooltips already created, create the tooltip
var opentip_formatting = { target:true, style:"dark", stem:"false", tipJoint:"top left", targetJoint:"bottom left" };
var created_tooltip_list = [];

function create_tooltip(model_id,target_name,target_difficulty,method_name,refinement_name,i_rmsd,l_rmsd,r_rmsd,fnat,i_l_rmsd) {
if ($.inArray(model_id, created_tooltip_list) == -1) {
	$(".row_id_"+model_id).each( function() {
	var tooltip = new Opentip($(this), opentip_formatting);
	var content = "<b>Model details</b><br><br>";
	content += "<table style=\"border-collapse: separate; border-spacing: 8px;\"><tr><td>Target</td><td>"+target_name+"</td></tr>";
	content += "<tr><td>Difficulty</td><td>"+target_difficulty+"</td></tr>";
	content += "<tr><td>Method</td><td>"+method_name+"</td></tr>";
	content += "<tr><td>Refinement</td><td>"+refinement_name+"</td></tr>";
	content += "<tr><td>I-RMSD</td><td>"+i_rmsd+"</td></tr>";
	content += "<tr><td>L-RMSD</td><td>"+l_rmsd+"</td></tr>";
	content += "<tr><td>R-RMSD</td><td>"+r_rmsd+"</td></tr>";
	content += "<tr><td>Fnat</td><td>"+fnat+"</td></tr>";
	content += "<tr><td>I-L-RMSD</td><td>"+i_l_rmsd+"</td></tr></table>";
	tooltip.setContent(content);
	});
	created_tooltip_list.push(model_id);
}
};
</script>
<style>
table.toptable
{
border-collapse:separate;
border-spacing:15px 10px;
}
</style>

<p><a href="{% url 'search' %}">Back to search</a></p>
{% endblock %}
