{% extends 'all/base.html' %}{% block title %}{{ target.name }} Models{% endblock %}
{% block content %}
{% django_js jquery=false %}
<h1>{{ target.name }} models</h1>

<p><a href="{% url 'target_info' target.name %}">View target details</a></p><br>

<button id="popover" type="button" class="btn btn-default">
  Select Columns
</button><br><br>

<table id="target_models_table" class="tablesorter bootstrap-popup">
<thead>
<tr>
<th data-priority="critical" class="filter-false sorter-false th.selectmodel">Select</th>
<th data-priority="1" class="filter-select th.method.name">Method</th>
<th data-priority="2" class="filter-select th.refinement.name">Refinement</th>
<th data-priority="3" class="th.i_rmsd" data-placeholder="e.g. '<=8'">I-RMSD</th>
<th data-priority="4" class="th.l_rmsd" data-placeholder="e.g. '<15'">L-RMSD</th>
<th data-priority="5" class="th.r_rmsd" data-placeholder="e.g. '<4'">R-RMSD</th>
<th data-priority="3" class="th.fnat" data-placeholder="e.g. '>0.5'">Fnat</th>
<th data-priority="5" class="th.i_l_rmsd" data-placeholder="e.g. '<3.1'">I-L-RMSD</th>
</tr>
</thead>
<tbody>
{% for model in results %}
<tr class="bodytr" name="{{ model.id }}">
<td class="td.modelcheckbox" style="width:40px"><center><input name="results/{{ model.method__name_lower }}/{{ model.refinement__name_lower }}/{{ model.target__difficulty_lower }}/{{ model.target__name }}/{{ model.target__name }}_{{ model.method__name_lower }}_{{ model.refinement__name_lower }}_{{ model.number }}.pdb-{{ model.target__receptor_bound_chain }}-fitted" class="modelcheckbox" type="checkbox"></center></td>
<td class="td.method.name" style='width:160px'>{{ model.method__name }}</td>
<td class="td.refinement.name" style='width:135px'>{{ model.refinement__name }}</td>
<td class="td.i_rmsd">{{ model.i_rmsd }}</td>
<td class="td.l_rmsd">{{ model.l_rmsd }}</td>
<td class="td.r_rmsd">{{ model.r_rmsd }}</td>
<td class="td.fnat" style='width:100px'>{{ model.fnat }}</td>
<td class="td.i_l_rmsd">{{ model.i_l_rmsd }}</td>
<td class="td.viewmodel" style='width:95px'><a href="{% url 'model' model.id %}">View model</a></td>
</tr>
{% endfor %}
</tbody>
</table>
<div id="ts-pager" class="ts-pager">
  <form>
    <img src="/static/tablesorter/addons/pager/icons/first.png" class="first"/>
    <img src="/static/tablesorter/addons/pager/icons/prev.png" class="prev"/>
    <span class="pagedisplay"></span>
    <img src="/static/tablesorter/addons/pager/icons/next.png" class="next"/>
    <img src="/static/tablesorter/addons/pager/icons/last.png" class="last"/>
    <select class="pagesize">
      <option selected="selected" value="10">10</option>
      <option value="20">20</option>
      <option value="30">30</option>
      <option value="40">40</option>
    </select>
  </form>
</div>
<br>
<input type="submit" value="Deselect all models" onclick="deselectmodels();">&nbsp;&nbsp;
<input type="submit" value="Update view" onclick="re_render();"><br>
<a href="{% url 'search' %}">Back to search</a>
<script>
$('#target_models_table .modelcheckbox').click(function(){
if (this.checked) {
	this.setAttribute('checked','checked');
}
if (!this.checked) {
	this.removeAttribute('checked');
}});
</script>
<script>
//colour array
var colour_array = ["lightgreen","gold","sienna","turquoise","darkgreen","orange","purple","slategray","mistyrose","beige"];
</script>

<input type="submit" id="deselectmodels" value="Deselect all models"><br>
<a href="{% url 'search' %}">Back to search</a><br>

<script>
$('#deselectmodels').click(function(){
    $('#target_models_table .modelcheckbox').prop('checked', false);
    $('#target_models_table .modelcheckbox').removeAttr('checked');
});
</script>

<style id="css">
#popover-target label {
  margin: 0 5px;
  display: block;
}
#popover-target input {
  margin-right: 5px;
}
.popover {
  margin-top: -65px; /* adjust popover position */
}
</style>
<script id="js">$(function() {

$('#popover')
    .popover({
      placement: 'right',
      html: true, // required if content has HTML
      content: '<div id="popover-target"></div>'
    })
    // bootstrap popover event triggered when the popover opens
    .on('shown.bs.popover', function () {
      // call this function to copy the column selection code into the popover
      $.tablesorter.columnSelector.attachTo( $('.bootstrap-popup'), '#popover-target');
    });


});
</script>

<table name="layout_table"><tr><td>
<script>
//jsmol scripts will go here
//create JSMol window
jmolApplet0 = Jmol.getApplet("jmolApplet0", info);
Jmol.script(jmolApplet0,"background white;");

function re_render() {
//need to unload files first?
//find which models are selected
var models_selected = [];
$('#target_models_table [checked="checked"]').each(function() {
boxid=this.getAttribute('name');
models_selected.push(Django.static(boxid));
});

//get static urls for native receptor and ligand
var receptor = Django.static('benchmarks/{{ target.name }}_r_b.pdb');
var native_ligand = Django.static('benchmarks/{{ target.name }}_l_b.pdb');

//only allow 10 models to be selected
if (models_selected.length > 10) {
	alert("Too many models selected: maximum 10");
} else {
	//construct load and colour command
	var load_files = "load FILES \""+receptor+"\" \""+native_ligand+"\"";
	for (var i=0; i<models_selected.length; i++) {
		load_files += " \""+models_selected[i]+"\"";
	}
	load_files += "; CARTOON only; frame ALL; hide ALL; {{ display_lig_chains }}; display displayed or *\/1; color *\/1 red; color *\/2 blue;";
	//load_files += "; CARTOON only; frame ALL; hide ALL; {{ display_lig_chains }};";
	//for (var i=0; i<models_selected.length; i++) {
	//	load_files += " color */"+(i+3)+" "+colour_array[i]+";";
	//}
	Jmol.script(jmolApplet0,load_files);
}
}
</script>
</td><td>
Red - Native receptor<br>
Blue - Native ligand<br><br>
The model ligands are coloured as shown in the table above
</td></tr></table>

<form name="term_form" onSubmit="return false">
JSMol terminal:&nbsp;&nbsp;<input type="text" name="terminal" style="width: 300px" />
<button onClick=update_Jmol(document.term_form.terminal.value)>Update</button>
<button onClick=reset_Jmol();>Reset</button></form><br>

<script>
$(document).ready(re_render());
</script>

{% endblock %}
